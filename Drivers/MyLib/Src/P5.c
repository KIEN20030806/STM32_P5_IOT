#include "P5.h"

unsigned char dem_hang = 0;
unsigned char buffer_display[3][32][8] = {0};
int MatrixX , MatrixY ;

unsigned char font[][7]=
{
0x00,0x00,0x00,0x00,0x00,0x00,0x00, //  32
0x10,0x38,0x38,0x10,0x10,0x00,0x10, //! 33
0x6C,0x6C,0x48,0x00,0x00,0x00,0x00, //" 34
0x00,0x28,0x7C,0x28,0x28,0x7C,0x28, //# 35
0x20,0x38,0x40,0x30,0x08,0x70,0x10, //$ 36
0x64,0x64,0x08,0x10,0x20,0x4C,0x4C, //% 37
0x20,0x50,0x50,0x20,0x54,0x48,0x34, //& 38
0x30,0x30,0x20,0x00,0x00,0x00,0x00, //' 39
0x10,0x20,0x20,0x20,0x20,0x20,0x10, //( 40
0x20,0x10,0x10,0x10,0x10,0x10,0x20, //) 41
0x00,0x28,0x38,0x7C,0x38,0x28,0x00, //* 42
0x00,0x10,0x10,0x7C,0x10,0x10,0x00, //+ 43
0x00,0x00,0x00,0x00,0x00,0x30,0x30, //, 44
0x00,0x00,0x00,0x7C,0x00,0x00,0x00, //- 45
0x00,0x00,0x00,0x00,0x00,0x30,0x30, //. 46
0x00,0x04,0x08,0x10,0x20,0x40,0x00, /// 47
0x38,0x44,0x4C,0x54,0x64,0x44,0x38, //0 48
0x10,0x10,0x10,0x10,0x10,0x10,0x10, //1 49
0x38,0x44,0x04,0x18,0x20,0x40,0x7C, //2 50
0x38,0x44,0x04,0x38,0x04,0x44,0x38, //3 51
0x08,0x18,0x28,0x48,0x7C,0x08,0x08, //4 52
0x7C,0x40,0x40,0x78,0x04,0x44,0x38, //5 53
0x18,0x20,0x40,0x78,0x44,0x44,0x38, //6 54
0x7C,0x04,0x08,0x10,0x20,0x20,0x20, //7 55
0x38,0x44,0x44,0x38,0x44,0x44,0x38, //8 56
0x38,0x44,0x44,0x3C,0x04,0x08,0x30, //9 57
0x00,0x00,0x30,0x30,0x00,0x30,0x30, //: 58
0x00,0x00,0x30,0x30,0x00,0x30,0x30, //; 59
0x08,0x10,0x20,0x40,0x20,0x10,0x08, //< 60
0x00,0x00,0x7C,0x00,0x00,0x7C,0x00, //= 61
0x20,0x10,0x08,0x04,0x08,0x10,0x20, //> 62
0x38,0x44,0x04,0x18,0x10,0x00,0x10, //? 63
0x38,0x44,0x5C,0x54,0x5C,0x40,0x38, //@ 64
0x38,0x44,0x44,0x44,0x7C,0x44,0x44, //A 65
0x78,0x44,0x44,0x78,0x44,0x44,0x78, //B 66
0x38,0x44,0x40,0x40,0x40,0x44,0x38, //C 67
0x78,0x44,0x44,0x44,0x44,0x44,0x78, //D 68
0x7C,0x40,0x40,0x78,0x40,0x40,0x7C, //E 69
0x7C,0x40,0x40,0x78,0x40,0x40,0x40, //F 70
0x38,0x44,0x40,0x5C,0x44,0x44,0x3C, //G 71
0x44,0x44,0x44,0x7C,0x44,0x44,0x44, //H 72
0x38,0x10,0x10,0x10,0x10,0x10,0x38, //I 73
0x04,0x04,0x04,0x04,0x44,0x44,0x38, //J 74
0x44,0x48,0x50,0x60,0x50,0x48,0x44, //K 75
0x40,0x40,0x40,0x40,0x40,0x40,0x7C, //L 76
0x44,0x6C,0x54,0x44,0x44,0x44,0x44, //M 77
0x44,0x64,0x54,0x4C,0x44,0x44,0x44, //N 78
0x38,0x44,0x44,0x44,0x44,0x44,0x38, //O 79
0x78,0x44,0x44,0x78,0x40,0x40,0x40, //P 80
0x38,0x44,0x44,0x44,0x54,0x48,0x34, //Q 81
0x78,0x44,0x44,0x78,0x48,0x44,0x44, //R 82
0x38,0x44,0x40,0x38,0x04,0x44,0x38, //S 83
0x7C,0x10,0x10,0x10,0x10,0x10,0x10, //T 84
0x44,0x44,0x44,0x44,0x44,0x44,0x38, //U 85
0x44,0x44,0x44,0x44,0x44,0x28,0x10, //V 86
0x44,0x44,0x54,0x54,0x54,0x54,0x28, //W 87
0x44,0x44,0x28,0x10,0x28,0x44,0x44, //X 88
0x44,0x44,0x44,0x28,0x10,0x10,0x10, //Y 89
0x78,0x08,0x10,0x20,0x40,0x40,0x78, //Z 90
0x38,0x20,0x20,0x20,0x20,0x20,0x38, //[ 91
0x00,0x40,0x20,0x10,0x08,0x04,0x00, //\ 92
0x38,0x08,0x08,0x08,0x08,0x08,0x38, //] 93
0x10,0x28,0x44,0x00,0x00,0x00,0x00, //^ 94
0x00,0x00,0x00,0x00,0x00,0x00,0x7C, //_ 95
0x30,0x30,0x10,0x00,0x00,0x00,0x00, //` 96
0x00,0x00,0x38,0x04,0x3C,0x44,0x3C, //a 97
0x40,0x40,0x78,0x44,0x44,0x44,0x78, //b 98
0x00,0x00,0x38,0x44,0x40,0x44,0x38, //c 99
0x04,0x04,0x3C,0x44,0x44,0x44,0x3C, //d 100
0x00,0x00,0x38,0x44,0x78,0x40,0x38, //e 101
0x18,0x20,0x20,0x78,0x20,0x20,0x20, //f 102
0x00,0x3C,0x44,0x44,0x3C,0x04,0x38, //g 103
0x40,0x40,0x70,0x48,0x48,0x48,0x48, //h 104
0x10,0x00,0x10,0x10,0x10,0x10,0x18, //i 105
0x08,0x00,0x18,0x08,0x08,0x48,0x30, //j 106
0x40,0x40,0x48,0x50,0x60,0x50,0x48, //k 107
0x20,0x20,0x20,0x20,0x20,0x20,0x38, //l 108
0x00,0x00,0x68,0x54,0x54,0x44,0x44, //m 109
0x00,0x00,0x70,0x48,0x48,0x48,0x48, //n 110
0x00,0x00,0x38,0x44,0x44,0x44,0x38, //o 111
0x00,0x78,0x44,0x44,0x44,0x78,0x40, //p 112
0x00,0x3C,0x44,0x44,0x44,0x3C,0x04, //q 113
0x00,0x00,0x58,0x24,0x20,0x20,0x70, //r 114
0x00,0x00,0x38,0x40,0x38,0x04,0x38, //s 115
0x00,0x20,0x78,0x20,0x20,0x28,0x10, //t 116
0x00,0x00,0x48,0x48,0x48,0x58,0x28, //u 117
0x00,0x00,0x44,0x44,0x44,0x28,0x10, //v 118
0x00,0x00,0x44,0x44,0x54,0x7C,0x28, //w 119
0x00,0x00,0x48,0x48,0x30,0x48,0x48, //x 120
0x00,0x48,0x48,0x48,0x38,0x10,0x60, //y 121
0x00,0x00,0x78,0x08,0x30,0x40,0x78, //z 122
0x18,0x20,0x20,0x60,0x20,0x20,0x18, //{ 123
0x10,0x10,0x10,0x10,0x10,0x10,0x10, //| 124
0x30,0x08,0x08,0x0C,0x08,0x08,0x30, //} 125
0x00,0x00,0x28,0x50,0x00,0x00,0x00, //~ 126
};

const unsigned char icon[7][8] = {
  {0x30,0x36,0x30,0x36,0x30,0x48,0x48,0x30}, //Tem
	{0x00,0x00,0x10,0x28,0x44,0x44,0x44,0x38},	//Hum
	{0x08,0x08,0x41,0x22,0x00,0x22,0x49,0x08},	//Bri
	{0x02,0x18,0x2A,0xC8,0xC8,0x2A,0x18,0x02}, 	//Noise
	{0x30,0x58,0x4E,0x89,0x83,0xA0,0x49,0x36},	//Air
	{0x00,0x42,0x24,0x18,0x18,0x24,0x42,0x00}, 	
	{0x00,0x00,0x02,0x04,0x88,0x50,0x20,0x00},	
};

void scan16S(char so)
{
	switch(so)
	{
		case 0:  Control_P->BSRR = A_RSET | B_RSET | C_RSET | D_RSET; return;
    case 1:  Control_P->BSRR = A_SSET | B_RSET | C_RSET | D_RSET; return;
    case 2:  Control_P->BSRR = A_RSET | B_SSET | C_RSET | D_RSET; return;
    case 3:  Control_P->BSRR = A_SSET | B_SSET | C_RSET | D_RSET; return;
    case 4:  Control_P->BSRR = A_RSET | B_RSET | C_SSET | D_RSET; return;
    case 5:  Control_P->BSRR = A_SSET | B_RSET | C_SSET | D_RSET; return;
    case 6:  Control_P->BSRR = A_RSET | B_SSET | C_SSET | D_RSET; return;
    case 7:  Control_P->BSRR = A_SSET | B_SSET | C_SSET | D_RSET; return;
    case 8:  Control_P->BSRR = A_RSET | B_RSET | C_RSET | D_SSET; return;
    case 9:  Control_P->BSRR = A_SSET | B_RSET | C_RSET | D_SSET; return;
    case 10: Control_P->BSRR = A_RSET | B_SSET | C_RSET | D_SSET; return;
    case 11: Control_P->BSRR = A_SSET | B_SSET | C_RSET | D_SSET; return;
    case 12: Control_P->BSRR = A_RSET | B_RSET | C_SSET | D_SSET; return;
    case 13: Control_P->BSRR = A_SSET | B_RSET | C_SSET | D_SSET; return;
    case 14: Control_P->BSRR = A_RSET | B_SSET | C_SSET | D_SSET; return;
    case 15: Control_P->BSRR = A_SSET | B_SSET | C_SSET | D_SSET; return;
	}
}

void chuyen(unsigned char byte_r1, unsigned char byte_g1, unsigned char byte_b1, 
            unsigned char byte_r2, unsigned char byte_g2, unsigned char byte_b2) 
{
    unsigned char i, mask;

    for (i = 0; i < 8; i++) 
    {
        mask = 0x80 >> i;

        // Ði?u khi?n các chân R1, G1, B1, R2, G2, B2 b?ng giá tr? c?a byte tuong ?ng
        if (byte_r1 & mask) {
						GPIOA->BSRR = (1 << R1_PIN);  // Set R1_PIN HIGH
				} else {
						GPIOA->BSRR = (1 << (R1_PIN + 16));  // Set R1_PIN LOW
				}

				if (byte_g1 & mask) {
						GPIOA->BSRR = (1 << G1_PIN);  // Set G1_PIN HIGH
				} else {
						GPIOA->BSRR = (1 << (G1_PIN + 16));  // Set G1_PIN LOW
				}

				if (byte_b1 & mask) {
						GPIOA->BSRR = (1 << B1_PIN);  // Set B1_PIN HIGH
				} else {
						GPIOA->BSRR = (1 << (B1_PIN + 16));  // Set B1_PIN LOW
				}

				if (byte_r2 & mask) {
						GPIOA->BSRR = (1 << R2_PIN);  // Set R2_PIN HIGH
				} else {
						GPIOA->BSRR = (1 << (R2_PIN + 16));  // Set R2_PIN LOW
				}

				if (byte_g2 & mask) {
						GPIOA->BSRR = (1 << G2_PIN);  // Set G2_PIN HIGH
				} else {
						GPIOA->BSRR = (1 << (G2_PIN + 16));  // Set G2_PIN LOW
				}

				if (byte_b2 & mask) {
						GPIOA->BSRR = (1 << B2_PIN);  // Set B2_PIN HIGH
				} else {
						GPIOA->BSRR = (1 << (B2_PIN + 16));  // Set B2_PIN LOW
				}
				clk_P->BSRR=(1<<(CLK_PIN+16));
        clk_P->BSRR=(1<<CLK_PIN);
    }
}

void ngatquetled() 
{
    unsigned char i;
		//OE_P->BSRR=(1<<(OE_PIN+16));
    OE_P->BSRR=(1<<OE_PIN);

    // Truy?n d? li?u ra ma tr?n LED
    for (i = 0; i < 8; i++) {
        chuyen(
            buffer_display[0][dem_hang][i], buffer_display[1][dem_hang][i], buffer_display[2][dem_hang][i],
            buffer_display[0][dem_hang + 16][i], buffer_display[1][dem_hang + 16][i], buffer_display[2][dem_hang + 16][i]
        );
    }
		OE_P->BSRR=(1<<(OE_PIN+16));
    scan16S(dem_hang);
    Control_P->BSRR=(1<<(LAT_PIN+16));
    Control_P->BSRR=(1<<LAT_PIN);
    // Tang hàng dang quét
    dem_hang++;
    if (dem_hang == 16) dem_hang = 0;
}

void Matrix_chonvitri(int x,int y)
{
	MatrixX=x;
	MatrixY=y;
}


void Matrix_setpx(int32_t x,int32_t y,unsigned char color)
{
	if(x>Graphic_x || y>Graphic_y || x<0 || y < 0)return;
	if((color&R_MASK)!=0)buffer_display[0][y][x/8] |= (0x80 >> (x%8)); //set R
	else buffer_display[0][y][x/8] &= ~(0x80 >> (x%8));                //clear R
	
	if((color&G_MASK)!=0)buffer_display[1][y][x/8] |= (0x80 >> (x%8)); //set G
	else buffer_display[1][y][x/8] &= ~(0x80 >> (x%8));                //clear G
	
	if((color&B_MASK)!=0)buffer_display[2][y][x/8] |= (0x80 >> (x%8)); //set B
	else buffer_display[2][y][x/8] &= ~(0x80 >> (x%8));                //clear B
}

void Matrix_guikitu(unsigned char txt,unsigned char color)
{
	 int x,y;
	 for(y=MatrixY;y<7+MatrixY;y++)
	 {
		 for(x=MatrixX;x<6+MatrixX;x++)
		 {
			 if ( (font[txt-32][y-MatrixY] & (0x80>>(x-MatrixX)))  != 0)Matrix_setpx(x,y,color);
			 else Matrix_setpx(x,y,0);
		 }
	 }
	 MatrixX+=6; //sau khi in xong thi tang con tro vi tri len
}



void Matrix_guichuoi(const char *s,unsigned char color)
{
  while(*s)
		{
			Matrix_guikitu(*s,color);
			s++;
		}
}

void Matrix_guichuoi_MAKE_COLOR(unsigned char *s,unsigned char *color)
{
	while(*s)
		{
			Matrix_guikitu(*s,*color);
			s++;color++;
		}
}

void Matrix_showIcon(int32_t x, int32_t y, int32_t k, unsigned char color) {
    int32_t i, j;
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 8; j++) {
            if (icon[k][i] & (0x80 >> j)) {
                Matrix_setpx(x + j, y + i, color);
            } else {
                Matrix_setpx(x + j, y + i, 0); // Clear pixel
            }
        }
    }
}

void Matrix_clearArea(int32_t x, int32_t y, int32_t width, int32_t height) {
    for (int32_t i = y; i < y + height; i++) {
        for (int32_t j = x; j < x + width; j++) {
            Matrix_setpx(j, i, 0); // Clear pixel
        }
    }
}


